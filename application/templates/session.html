{% extends "layout.html" %}

{% block page_styles %}
<link rel="stylesheet" href="../static/css/session.css?v=1.3">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.0/animate.min.css"/>
{% endblock page_styles %}

{% block content %}
    <!-- <script>
        window.onbeforeunload = function() {
            return true;
        };
    </script> -->

    <h1>Your Posture Session</h1>
    <h3 style="margin-bottom: -25px">{{ header }}</h3>
    <div id="main-div">
        <div class = "row">
            <div class="col-md-6">
                <div class="content-div">
                    <h2>Screen Proximity</h2>
                </div>                  
            </div>
            <div class = "col-md-6">
                <div class="content-div">
                    <h2>Slump Detection</h2>
                </div>
            </div>
        </div>
        <div class = "row">
            <div class="col-md-6">
                <div class="content-div">
                    <h2>Forward Tilt</h2>
                </div>
            </div>
            <div class="col-md-6">
                <div class="content-div">
                    <h2>Head Tilt</h2>
                </div>
            </div>
        </div>
        <div class = "row">
            <div class="col-md-6">
                <div class="content-div">
                    <h2>Shoulder Tilt</h2>
                </div>
            </div>
            <div class="col-md-6">
                <div class="content-div">
                    <h2>Shoulder Width</h2>
                </div>
            </div>
        </div>
        <!-- <h5>Graphs Last Updated: 37s ago</h5> -->
        <div class="row">
            <a href="{{ url_for('end_session', session_id=session_id) }}" class="btn btn-red btn-wide" style="margin-top: 30px">End Session</a>
        </div>
        <div class="row" style="margin-top: 30px; display: flex; flex-direction: column; align-items: center; justify-content: center">
            <div id="my_photo_booth">
                <div id="my_camera"></div>
            
                    <script src="{{url_for('static',filename='js/webcam.min.js')}}"></script>
                    <script src="{{url_for('static',filename='audio/shutter.mp3')}}"></script>
                    <script src="{{url_for('static',filename='audio/shutter.ogg')}}"></script>
            
                    <!-- Configure a few settings and attach camera -->
                    <script language="JavaScript">
                        Webcam.set({
                            // live preview size
                            width: 640,
                            height: 360,
            
                            // device capture size
                            dest_width: 960,
                            dest_height: 540,
            
                            // final cropped size
                            crop_width: 960,
                            crop_height: 540,
            
                            // format and quality
                            image_format: 'jpeg',
                            jpeg_quality: 90,
            
                            // flip horizontal (mirror mode)
                            flip_horiz: true
                        });
                        Webcam.attach( '#my_camera' );
                    </script>
            </div>
        </div>
    </div>

    <script language="JavaScript">
        // preload shutter audio clip
        // var shutter = new Audio();
        // shutter.autoplay = false;
        // shutter.src = navigator.userAgent.match(/Firefox/) ? '/static/audio/shutter.ogg' : '/static/audio/shutter.mp3';
    

        // function preview_snapshot() {
        //     // play sound effect
        //     try { shutter.currentTime = 0; } catch(e) {;} // fails in IE
        //     shutter.play();
    
        //     // freeze camera so user can preview current frame
        //     Webcam.freeze();
    
        //     // swap button sets
        //     document.getElementById('pre_take_buttons').style.display = 'none';
        //     document.getElementById('post_take_buttons').style.display = '';
        // }
    
        // function cancel_preview() {
        //     // cancel preview freeze and return to live camera view
        //     Webcam.unfreeze();
    
        //     // swap buttons back to first set
        //     document.getElementById('pre_take_buttons').style.display = '';
        //     document.getElementById('post_take_buttons').style.display = 'none';
        // }
    
        function save_photo() {
            $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
            // actually snap photo (from preview freeze).
            Webcam.snap( function(data_uri) {
                // display results in page
                // console.log(data_uri);
    
                // shut down camera, stop capturing
                // Webcam.reset();

            // var xhr = new XMLHttpRequest();
            // var url = $SCRIPT_ROOT + '/photo_analysis/{{ session_id }}';
            // xhr.open("POST", url, true);
            // xhr.setRequestHeader("Content-Type", "application/json");
            // xhr.onreadystatechange = function () {
            //     if (xhr.readyState === 4 && xhr.status === 200) {
            //         var json = JSON.parse(xhr.responseText);
            //     }
            // };
            // var data = JSON.stringify({"image": data_uri});
            // xhr.send(data);

            $.ajax({
                type: "POST",
                url: $SCRIPT_ROOT + '/photo_analysis/{{ session_id }}',
                data: JSON.stringify({"image": data_uri}),
                success: function(){},
                dataType: "json",
                contentType : "application/json"
            });

                // $.getJSON($SCRIPT_ROOT + '/photo_analysis/{{ session_id }}', {
                //     photo_cap: data_uri,
                // },function(data){
                //     var response = data.response;
                // });
    
            } );
        }

        setInterval(save_photo, 5000)
    </script>

{% endblock content %}